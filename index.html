<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é–‹æºç¡¬é«”æ¸…å–®</title>

    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />

    <style>
      ion-item {
        max-width: 40rem;
        margin: auto;
      }
      ion-content {
        --padding-start: 1rem;
        --padding-end: 1rem;
        --padding-bottom: 4rem;
      }
      .item-content {
        width: 100%;
      }
      .item-title {
        font-weight: bold;
        margin: 0.25rem 0;
      }
      .item-subtitle {
        color: var(--ion-color-medium);
        font-size: 0.9em;
      }
      .item-imge img {
        width: 100%;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
      }
      .item-videos iframe {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
      }
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        gap: 1rem;
      }
      .page-info {
        font-size: 0.9em;
        color: var(--ion-color-medium);
      }
      ion-toolbar ion-button {
        margin-left: auto;
      }
    </style>
  </head>

  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>é–‹æºç¡¬é«”æ¸…å–®</ion-title>
            <ion-back-button defaultHref="index.html"></ion-back-button>
          <ion-buttons slot="end">
          <ion-button color="primary">Login</ion-button>
            <ion-button id="resetFilters">é‡è¨­</ion-button>
          </ion-buttons>
        </ion-toolbar>

        <ion-searchbar placeholder="æœå°‹..."></ion-searchbar>

        <ion-item>
          <ion-select label="åˆ†é¡" interface="popover">
            <ion-select-option value="">å…¨éƒ¨</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-header>

      <ion-content>
        <div class="pagination-container" id="paginationContainer"></div>
        <ion-list id="itemList">
          <!-- é è¨­æ¨¡æ¿ (æœƒè¢« clone) -->
          <ion-item class="list-item" style="display: none;">
            <div class="item-content">
              <div class="item-title">æ¨™é¡Œ</div>
              <div class="item-subtitle">åˆ†é¡</div>
              <div class="item-details">æè¿°</div>
              <div class="item-highlights">ç‰¹é»</div>

              <div class="item-imge">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg"
                />
              </div>

              <div class="item-videos">
                <iframe
                  src="https://www.youtube.com/embed/QxPBCBX8ac8"
                  allowfullscreen
                ></iframe>
              </div>

              <div class="tag-container">
                <ion-chip size="small">åˆ†é¡</ion-chip>
              </div>
            </div>
          </ion-item>
        </ion-list>

        <div class="pagination-container" id="paginationContainerBottom"></div>
      </ion-content>
    </ion-app>

    <script>
      // === å…¨å±€è®Šæ•¸ ===
      let currentPage = 1;
      let maxPage = 1;
      let searchTerm = "";
      let selectedCategory = "";

      // === DOM å…ƒç´  ===
      const searchbar = document.querySelector("ion-searchbar");
      const list = document.getElementById("itemList");
      const template = document.querySelector(".list-item");
      const paginationContainers = document.querySelectorAll(
        ".pagination-container"
      );
      const categorySelect = document.querySelector("ion-select");
      const resetButton = document.getElementById("resetFilters");

      // === åˆå§‹åŒ– ===
      document.addEventListener("DOMContentLoaded", function () {
        updatelist(1);

        // ğŸ” æœå°‹åŠŸèƒ½
        let searchTimer;
        searchbar.addEventListener("ionInput", (event) => {
          searchTerm = searchbar.value.trim();
          clearTimeout(searchTimer);
          searchTimer = setTimeout(() => {
            currentPage = 1;
            updatelist(1);
          }, 1000);
        });

        // ğŸ·ï¸ åˆ†é¡ç¯©é¸
        categorySelect.addEventListener("ionChange", (event) => {
          selectedCategory = event.detail.value;
          currentPage = 1;
          updatelist(1);
        });

        // ğŸ”„ é‡è¨­ç¯©é¸
        resetButton.addEventListener("click", () => {
          searchTerm = "";
          selectedCategory = "";
          searchbar.value = "";
          categorySelect.value = "";
          currentPage = 1;
          updatelist(1);
        });
      });

      // === åˆ†é æ§åˆ¶ ===
      function goToPrevPage() {
        if (currentPage > 1) updatelist(currentPage - 1);
      }
      function goToNextPage() {
        if (currentPage < maxPage) updatelist(currentPage + 1);
      }

      // === æ›´æ–°æ¸…å–® ===
      async function updatelist(page = 1) {
        list.innerHTML = "Loading...";

        try {
          const baseUrl = "https://dae-mobile-assignment.hkit.cc/api";
          let url = `${baseUrl}/hardware?page=${page}`;

          if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
          if (selectedCategory)
            url += `&category=${encodeURIComponent(selectedCategory)}`;

          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! ${response.status}`);

          const json = await response.json();
          console.log("API Response:", json);

          list.innerHTML = "";

          // === ç„¡çµæœ ===
          if (!json.items || json.items.length === 0) {
            const noItem = document.createElement("ion-item");
            noItem.innerHTML = `
              <ion-label class="ion-text-center">
                <h2>æ²’æœ‰æ‰¾åˆ°ç›¸é—œé …ç›®</h2>
                <p>è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶</p>
              </ion-label>`;
            list.appendChild(noItem);
          } else {
            // === é¡¯ç¤ºé …ç›® ===
            for (const item of json.items) {
              const node = template.cloneNode(true);
              node.style.display = "block";
              node.querySelector(".item-title").textContent = item.title;
              node.querySelector(".item-subtitle").textContent = item.category;
              node.querySelector(".item-details").textContent =
                item.description;
              node.querySelector(".item-highlights").textContent =
                item.highlight || "";

              // åœ–ç‰‡
              if (item.image_url) {
                node.querySelector(".item-imge img").src = item.image_url;
              } else {
                node.querySelector(".item-imge").innerHTML = "";
              }

              // å½±ç‰‡
              if (item.video_url) {
                node.querySelector(".item-videos iframe").src =
                  item.video_url.replace(
                    "https://www.youtube.com/watch?v=",
                    "https://www.youtube.com/embed/"
                  );
              } else {
                node.querySelector(".item-videos").innerHTML = "";
              }

              // æ¨™ç±¤
              const tagContainer = node.querySelector(".tag-container");
              tagContainer.innerHTML = "";
              if (item.tags && Array.isArray(item.tags)) {
                for (const tag of item.tags) {
                  const chip = document.createElement("ion-chip");
                  chip.size = "small";
                  chip.textContent = tag;
                  tagContainer.appendChild(chip);
                }
              }

              list.appendChild(node);
            }
          }

          // === åˆ†é è³‡è¨Š ===
          if (json.pagination) {
            currentPage = parseInt(json.pagination.page) || 1;
            const total = parseInt(json.pagination.total) || 0;
            const perPage = parseInt(json.pagination.limit) || 10;
            maxPage = perPage > 0 ? Math.ceil(total / perPage) : 1;
          } else {
            currentPage = 1;
            maxPage = 1;
          }

          // === å‹•æ…‹å»ºç«‹åˆ†é¡é¸é …ï¼ˆåªå»ºç«‹ä¸€æ¬¡ï¼‰ ===
          updateCategoryOptions(json.items);

          // === æ›´æ–°åˆ†é æŒ‰éˆ• ===
          paginationContainers.forEach(updatePaginationControls);
        } catch (error) {
          console.error("Failed to load data:", error);

          const alert = document.createElement("ion-alert");
          alert.header = "è¼‰å…¥ç¡¬é«”åˆ—è¡¨å¤±æ•—";
          alert.message = error.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
          alert.buttons = [
            {
              text: "é‡è©¦",
              handler: () => updatelist(currentPage),
            },
          ];
          document.body.appendChild(alert);
          await alert.present();
        }
      }

      // === å‹•æ…‹ç”Ÿæˆåˆ†é¡é¸å–® ===
      function updateCategoryOptions(items) {
        if (!items || items.length === 0) return;

        const existingOptions = categorySelect.querySelectorAll(
          "ion-select-option"
        );
        if (existingOptions.length <= 1) {
          const categories = new Set(
            items.map((item) => item.category).filter(Boolean)
          );
          categories.forEach((cat) => {
            const opt = document.createElement("ion-select-option");
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
          });
        }
      }

      // === åˆ†é æ§åˆ¶å€ ===
      function updatePaginationControls(container) {
        container.innerHTML = `
          <ion-button id="prevPage" ${currentPage <= 1 ? "disabled" : ""}>
            <ion-icon name="chevron-back-outline"></ion-icon>
            ä¸Šä¸€é 
          </ion-button>
          <div class="page-info">ç¬¬ ${currentPage} / ${maxPage} é </div>
          <ion-button id="nextPage" ${currentPage >= maxPage ? "disabled" : ""}>
            ä¸‹ä¸€é 
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        `;
        container
          .querySelector("#prevPage")
          ?.addEventListener("click", goToPrevPage);
        container
          .querySelector("#nextPage")
          ?.addEventListener("click", goToNextPage);
      }
    </script>
  </body>
</html>
