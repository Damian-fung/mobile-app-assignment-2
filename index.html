<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>開源硬體清單</title>

    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />

    <style>
      ion-item {
        max-width: 40rem;
        margin: auto;
      }
      ion-content {
        --padding-start: 1rem;
        --padding-end: 1rem;
        --padding-bottom: 4rem;
      }
      .item-content {
        width: 100%;
      }
      .item-title {
        font-weight: bold;
        margin: 0.25rem 0;
      }
      .item-subtitle {
        color: var(--ion-color-medium);
        font-size: 0.9em;
      }
      .item-imge img {
        width: 100%;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
      }
      .item-videos iframe {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
      }
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        gap: 1rem;
      }
      .page-info {
        font-size: 0.9em;
        color: var(--ion-color-medium);
      }
      ion-toolbar ion-button {
        margin-left: auto;
      }
      /* 添加 modal 內容樣式 */
      .modal-content {
        padding: 1rem;
      }
      .modal-content ion-input {
        margin-bottom: 1rem;
      }
      .modal-link {
        text-align: center;
        margin-top: 1rem;
      }
    </style>
  </head>

  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>開源硬體清單</ion-title>
          <ion-buttons slot="start">
            <ion-back-button defaultHref="index.html"></ion-back-button>
          </ion-buttons>
          <ion-buttons slot="end">
            <ion-button id="LoginButton" color="light">Login</ion-button>
            <ion-button id="RegisterButton" color="light">Register</ion-button>
          </ion-buttons>
        </ion-toolbar>

        <ion-searchbar placeholder="搜尋..."></ion-searchbar>

        <ion-item>
          <ion-select label="分類" interface="popover">
            <ion-select-option value="">全部</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-header>

      <ion-content>
        <div class="pagination-container" id="paginationContainer"></div>
        <ion-list id="itemList">
          <!-- 預設模板 (會被 clone) -->
          <ion-item class="list-item" style="display: none;">
            <div class="item-content">
              <div class="item-title">標題</div>
              <div class="item-subtitle">分類</div>
              <div class="item-details">描述</div>
              <div class="item-highlights">特點</div>

              <div class="item-imge">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg"
                />
              </div>

              <div class="item-videos">
                <iframe
                  src="https://www.youtube.com/embed/QxPBCBX8ac8"
                  allowfullscreen
                ></iframe>
              </div>

              <div class="tag-container">
                <ion-chip size="small">分類</ion-chip>
              </div>
            </div>
          </ion-item>
        </ion-list>

        <div class="pagination-container" id="paginationContainerBottom"></div>
      </ion-content>

      <!-- 登入 Modal -->
      <ion-modal id="loginModal" trigger="LoginButton">
        <ion-header>
          <ion-toolbar color="primary">
            <ion-buttons slot="start">
              <ion-button color="light" id="closeLoginModalBtn">Close</ion-button>
            </ion-buttons>
            <ion-title>Login</ion-title>
          </ion-toolbar>
        </ion-header>
        <ion-content class="modal-content">
          <ion-input type="text" label="Username" placeholder="請輸入用戶名"></ion-input>
          <ion-input type="password" label="Password" placeholder="請輸入密碼"></ion-input>
          <ion-button class="ion-margin-top" expand="block"onclick="submitlogin()">Login</ion-button>
         <p><ion-text id="loginResultTText"></p>

            <p>Don't have an account? 
              <a href="#" onclick="switchToRegisterModal()">Register</a>
            </p>
          </div>
        </ion-content>
      </ion-modal>

      <!-- 註冊 Modal -->
      <ion-modal id="registerModal" trigger="RegisterButton">
        <ion-header>
          <ion-toolbar color="primary">
            <ion-buttons slot="start">
              <ion-button color="light" id="closeRegisterModalBtn">Close</ion-button>
            </ion-buttons>
            <ion-title>Register</ion-title>
          </ion-toolbar>
        </ion-header>
        <ion-content class="modal-content">
          <ion-input type="text" label="Username" placeholder="請輸入用戶名"></ion-input>
          <ion-input type="email" label="Email" placeholder="請輸入電子郵件"></ion-input>
          <ion-input type="password" label="Password" placeholder="請輸入密碼"></ion-input>
          <ion-button class="ion-margin-top" expand="block"onclick=submitRegister()>Register</ion-button>
          <div class="modal-link">
            <p>Already have an account?
              <a href="#" onclick="switchToLoginModal()">Login</a>
            </p>
          </div>
        </ion-content>
      </ion-modal>
    </ion-app>

    <script>
      // === 全局變數 ===
      let currentPage = 1;
      let maxPage = 1;
      let searchTerm = "";
      let selectedCategory = "";

      // === DOM 元素 ===
      const searchbar = document.querySelector("ion-searchbar");
      const list = document.getElementById("itemList");
      const template = document.querySelector(".list-item");
      const paginationContainers = document.querySelectorAll(
        ".pagination-container"
      );
      const categorySelect = document.querySelector("ion-select");

      // === Modal 元素 ===
      const loginModal = document.getElementById('loginModal');
      const registerModal = document.getElementById('registerModal');

      // === 初始化 ===
      document.addEventListener("DOMContentLoaded", function () {
        updatelist(1);

        // 🔍 搜尋功能
        let searchTimer;
        searchbar.addEventListener("ionInput", (event) => {
          searchTerm = searchbar.value.trim();
          clearTimeout(searchTimer);
          searchTimer = setTimeout(() => {
            currentPage = 1;
            updatelist(1);
          }, 1000);
        });

        // 🏷️ 分類篩選
        categorySelect.addEventListener("ionChange", (event) => {
          selectedCategory = event.detail.value;
          currentPage = 1;
          updatelist(1);
        });

        // 關閉 modal 功能
        const closeLoginButton = document.getElementById("closeLoginModalBtn");
        if (closeLoginButton) {
          closeLoginButton.addEventListener("click", function() {
            if (loginModal) {
              loginModal.dismiss();
            }
          });
        }

        const closeRegisterButton = document.getElementById("closeRegisterModalBtn");
        if (closeRegisterButton) {
          closeRegisterButton.addEventListener("click", function() {
            if (registerModal) {
              registerModal.dismiss();
            }
          });
        }

        // 切換 modal 功能
        const goToRegisterLink = document.getElementById("goToRegisterFromLogin");
        if (goToRegisterLink) {
          goToRegisterLink.addEventListener("click", function(e) {
            e.preventDefault();
            if (loginModal && registerModal) {
              loginModal.dismiss();
              registerModal.present();
            }
          });
        }

        const goToLoginLink = document.getElementById("goToLoginFromRegister");
        if (goToLoginLink) {
          goToLoginLink.addEventListener("click", function(e) {
            e.preventDefault();
            if (registerModal && loginModal) {
              registerModal.dismiss();
              loginModal.present();
            }
          });
        }
      });

      // === 分頁控制 ===
      function goToPrevPage() {
        if (currentPage > 1) updatelist(currentPage - 1);
      }
      function goToNextPage() {
        if (currentPage < maxPage) updatelist(currentPage + 1);
      }
       const baseUrl = "https://dae-mobile-assignment.hkit.cc/api";
      // === 更新清單 ===
      async function updatelist(page = 1) {
        list.innerHTML = "Loading...";

        try {
          let url = `${baseUrl}/hardware?page=${page}`;

          if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
          if (selectedCategory)
            url += `&category=${encodeURIComponent(selectedCategory)}`;

          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! ${response.status}`);

          const json = await response.json();
          console.log("API Response:", json);

          list.innerHTML = "";

          // === 無結果 ===
          if (!json.items || json.items.length === 0) {
            const noItem = document.createElement("ion-item");
            noItem.innerHTML = `
              <ion-label class="ion-text-center">
                <h2>沒有找到相關項目</h2>
                <p>請嘗試其他搜尋條件</p>
              </ion-label>`;
            list.appendChild(noItem);
          } else {
            // === 顯示項目 ===
            for (const item of json.items) {
              const node = template.cloneNode(true);
              node.style.display = "block";
              node.querySelector(".item-title").textContent = item.title;
              node.querySelector(".item-subtitle").textContent = item.category;
              node.querySelector(".item-details").textContent =
                item.description;
              node.querySelector(".item-highlights").textContent =
                item.highlight || "";

              // 圖片
              if (item.image_url) {
                node.querySelector(".item-imge img").src = item.image_url;
              } else {
                node.querySelector(".item-imge").innerHTML = "";
              }

              // 影片
              if (item.video_url) {
                node.querySelector(".item-videos iframe").src =
                  item.video_url.replace(
                    "https://www.youtube.com/watch?v=",
                    "https://www.youtube.com/embed/"
                  );
              } else {
                node.querySelector(".item-videos").innerHTML = "";
              }

              // 標籤
              const tagContainer = node.querySelector(".tag-container");
              tagContainer.innerHTML = "";
              if (item.tags && Array.isArray(item.tags)) {
                for (const tag of item.tags) {
                  const chip = document.createElement("ion-chip");
                  chip.size = "small";
                  chip.textContent = tag;
                  tagContainer.appendChild(chip);
                }
              }

              list.appendChild(node);
            }
          }

          // === 分頁資訊 ===
          if (json.pagination) {
            currentPage = parseInt(json.pagination.page) || 1;
            const total = parseInt(json.pagination.total) || 0;
            const perPage = parseInt(json.pagination.limit) || 10;
            maxPage = perPage > 0 ? Math.ceil(total / perPage) : 1;
          } else {
            currentPage = 1;
            maxPage = 1;
          }

          // === 動態建立分類選項（只建立一次） ===
          updateCategoryOptions(json.items);

          // === 更新分頁按鈕 ===
          paginationContainers.forEach(updatePaginationControls);
        } catch (error) {
          console.error("Failed to load data:", error);

          const alert = document.createElement("ion-alert");
          alert.header = "載入硬體列表失敗";
          alert.message = error.message || "發生未知錯誤";
          alert.buttons = [
            {
              text: "重試",
              handler: () => updatelist(currentPage),
            },
          ];
          document.body.appendChild(alert);
          await alert.present();
        }
      }

      // === 動態生成分類選單 ===
      function updateCategoryOptions(items) {
        if (!items || items.length === 0) return;

        const existingOptions = categorySelect.querySelectorAll(
          "ion-select-option"
        );
        if (existingOptions.length <= 1) {
          const categories = new Set(
            items.map((item) => item.category).filter(Boolean)
          );
          categories.forEach((cat) => {
            const opt = document.createElement("ion-select-option");
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
          });
        }
      }

      // === 分頁控制區 ===
      function updatePaginationControls(container) {
        container.innerHTML = `
          <ion-button id="prevPage" ${currentPage <= 1 ? "disabled" : ""}>
            <ion-icon name="chevron-back-outline"></ion-icon>
            上一頁
          </ion-button>
          <div class="page-info">第 ${currentPage} / ${maxPage} 頁</div>
          <ion-button id="nextPage" ${currentPage >= maxPage ? "disabled" : ""}>
            下一頁
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        `;
        container
          .querySelector("#prevPage")
          ?.addEventListener("click", goToPrevPage);
        container
          .querySelector("#nextPage")
          ?.addEventListener("click", goToNextPage);
      }
      function switchToRegisterModal() {
        loginModal.dismiss();
        registerModal.present();

        registerModal.querySelector('ion-input[name="username"]').value = 
        loginModal.querySelector('ion-input[name="username"]').value

         registerModal.querySelector('ion-input[name="password"]').value = 
        loginModal.querySelector('ion-input[name="password"]').value

        registerModal.querySelector('ion-input[name="confirmPassword"]').value = ''
      }
      function switchToLoginModal() {
        registerModal.dismiss();
        loginModal.present();

        loginModal.querySelector('ion-input[name="username"]').value = 
        registerModal.querySelector('ion-input[name="username"]').value

         loginModal.querySelector('ion-input[name="password"]').value = 
        registerModal.querySelector('ion-input[name="password"]').value
      }

      async function submitlogin() {
        let username = loginModal.querySelector('ion-input[label="username"]').value;
        let password = loginModal.querySelector('ion-input[label="password"]').value;
        let res = await fetch(`${baseUrl}/auth/login`, {
          method: "POST",
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username, password }),
      })
      let json = await res.json();
      console.log("Login json:", json);
      if (json.error){
        loginResultText.color ='danger'
        loginResult.textContent = json.error
        return
      } else {
        loginResultText.color = 'success'
        loginResult.textContent = 'Login successful';
        localStorage.setItem('token',json.token)
        setTimeout(() => { loginModal.dismiss()
        },2000)
      }
    }
    </script>
  </body>
</html>