<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>開源硬體</title>
    <!-- Ionic CDN -->
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule
      src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"
    />
    <style>
      ion-item {
        max-width: 40rem;
      }
      .item-content {
        width: 100%;
      }
      .item-title {
        font-weight: bold;
        margin: 0.25rem 0;
      }
      .item-subtitle {
        color: var(--ion-color-medium);
        font-size: 0.9em;
      }
      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar>
          <ion-title>開源硬體</ion-title>
        </ion-toolbar>
        <ion-searchbar placeholder="搜尋..."></ion-searchbar>
        <ion-item>
          <ion-select label="分類" interface="popover">
            <ion-select-option value="">全部</ion-select-option>
            <!-- 根據主題加入分類選項 -->
          </ion-select>
        </ion-item>
      </ion-header>

      <ion-content>
        <ion-list>
          <!-- 清單項目範本 -->
          <ion-item class="list-item">
            <div class="item-content">
              <div class="item-title">標題</div>
              <div class="item-subtitle">副標題</div>
              <div class="item-details">詳細資訊</div>
              <div class="item-highlights">特點</div>
              <div class="item-imge">
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg"
                />
              </div>

              <div class="item-videos">
                <iframe
                  width="560"
                  height="315"
                  src="https://www.youtube.com/embed/QxPBCBX8ac8"
                  title="YouTube video player"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allowfullscreen
                ></iframe>
              </div>

              <div class="tag-container">
                <ion-chip size="small">分類</ion-chip>
                <!-- 標籤 -->
              </div>
            </div>
          </ion-item>
        </ion-list>
      </ion-content>
    </ion-app>
    <script src="post.js"></script>

    <script>
      let searchbar = document.querySelector("ion-searchbar");
      let list = document.querySelector("ion-list");
      let template = document.querySelector(".list-item");

      async function updatelist() {
        let baseUrl = "https://dae-mobile-assignment.hkit.cc/api";
        let json = await fetch(`${baseUrl}/hardware`, {
          method: "GET",
        })
          .catch(() => {
            return {
              error: "Network Error: please check your wifi connection",
            };

          })
          .then((res) => {
            if (res.error) {
              return res;
            }
            return res.json();
          });
        console.log(json);
        if (json.error) {
          const alert = document.createElement("ion-alert");
          alert.header = "Failed to load hardware list";
          alert.message = json.error;
          alert.buttons = ["Action"];
          alert.buttons= [ {
            text: 'Retry',
            handler: () => {
              updatelist();
            }
          } ];
          

          document.body.appendChild(alert);
          await alert.present();
          return;
        }

        list.innerText = "";

        for (let item of json.items) {
          if (
            !searchbar.value ||
            item.title
              .toLocaleLowerCase()
              .includes(searchbar.value.toLocaleLowerCase())
          ) {
            let node = template.cloneNode(true);
            node.querySelector(".item-title").textContent = item.title;
            node.querySelector(".item-subtitle").textContent = item.category;
            node.querySelector(".item-details").textContent = item.description;
            node.querySelector(".item-highlights").textContent = item.highlight;
            node.querySelector(".item-videos iframe").src =
              item.video_url.replace(
                "https://www.youtube.com/watch?v=",
                "https://www.youtube.com/embed/"
              );
            node.querySelector(".item-imge img").src = item.image_url;
            node.querySelector(".tag-container").innerHTML = "";
            for (let tag of item.tags) {
              let chip = document.createElement("ion-chip");
              chip.size = "small";
              chip.textContent = tag;
              node.querySelector(".tag-container").appendChild(chip);
            }

            list.appendChild(node);
          }
        }
      }

      updatelist();

      let searchTimer 
      searchbar.addEventListener("ionInput", (event) => {
        // 實作搜尋邏輯
        console.log(searchbar.value);
        console.log('will auto search after 1 second...')
        clearTimeout(searchTimer)
        searchTimer = setTimeout(() => {
          updatelist();
        }, 1000);
      });
    </script>
  </body>
</html>
